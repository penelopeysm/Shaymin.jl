on:
  push:
    branches:
      - "*"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: DynamicPPL@0.31.0 (old syntax)
        shell: julia --color=yes --project=. {0}
        run: |
          using Pkg
          Pkg.add(name="DynamicPPL", version="0.31.0")
          Pkg.add("Chairmarks")
          Pkg.add("Distributions")

          using DynamicPPL
          using Chairmarks
          using Distributions

          @model function g1()
              return x ~ Normal()
          end
          @model function f1()
              x = @submodel g1()
              return y ~ Normal(x, 1)
          end

          t = @be f1()()
          show(Base.stdout, MIME"text/plain"(), t)

      - name: DynamicPPL@0.31.1 (old syntax)
        shell: julia --color=yes --project=. {0}
        run: |
          using Pkg
          Pkg.add(name="DynamicPPL", version="0.31.1")

          using DynamicPPL
          using Chairmarks
          using Distributions

          @model function g2()
              return x ~ Normal()
          end
          @model function f2()
              x = @submodel g2()
              return y ~ Normal(x, 1)
          end

          t = @be f2()()
          show(Base.stdout, MIME"text/plain"(), t)

      - name: DynamicPPL@0.31.1 (new syntax)
        shell: julia --color=yes --project=. {0}
        run: |
          using Pkg
          Pkg.add(name="DynamicPPL", version="0.31.1")

          using DynamicPPL
          using Chairmarks
          using Distributions

          @model function g3()
              return x ~ Normal()
          end
          @model function f3()
              x ~ to_submodel(g3())
              return y ~ Normal(x, 1)
          end

          t = @be f3()()
          show(Base.stdout, MIME"text/plain"(), t)
