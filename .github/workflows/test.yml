on:
  push:
    branches:
      - "*"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: julia-actions/setup-julia@v2
        with:
          version: '1'

      - name: DynamicPPL@0.31.0 (old syntax)
        shell: julia --color=yes --project=. {0}
        run: |
          using Pkg
          Pkg.add(name="DynamicPPL", version="0.31.0")
          Pkg.add("Chairmarks")

          using DynamicPPL
          using Chairmarks

          @model function g()
              return x ~ Normal()
          end
          @model function f()
              x = @submodel g()
              return y ~ Normal(x, 1)
          end

          @be f()()

      - name: DynamicPPL@0.31.1 (old syntax)
        shell: julia --color=yes --project=. {0}
        run: |
          using Pkg
          Pkg.add(name="DynamicPPL", version="0.31.1")
          Pkg.add("Chairmarks")

          using DynamicPPL
          using Chairmarks

          @model function g()
              return x ~ Normal()
          end
          @model function f()
              x = @submodel g()
              return y ~ Normal(x, 1)
          end

          @be f()()

      - name: DynamicPPL@0.31.1 (new syntax)
        shell: julia --color=yes --project=. {0}
        run: |
          using Pkg
          Pkg.add(name="DynamicPPL", version="0.31.1")
          Pkg.add("Chairmarks")

          using DynamicPPL
          using Chairmarks

          @model function g()
              return x ~ Normal()
          end
          @model function f()
              x ~ to_submodel(g())
              return y ~ Normal(x, 1)
          end

          @be f()()
